<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WebSocket示例</title>
  <style type="text/css">
  .main {
    margin: 0 auto;
    text-align: center;
  }
  </style>
</head>
<body>
<div class="main">
  <h3>画布</h3>
  <canvas id="content" width="1025px" height="769px"></canvas>
</div>

<script type="text/javascript">
  var wsServer = "ws://"+window.location.host+"/wsDemo";
  var websocket = new WebSocket(wsServer);
  websocket.binaryType = "arraybuffer";
  websocket.onopen = function() {
    console.log("Connected to WebSocket server");
  };
  websocket.onclose = function (evt) { 
    console.log("Disconnected!");
  }; 
  websocket.onmessage = function(evt) {
    // console.log('Retrieved data from server: ' + evt.data);
    var info = JSON.parse(evt.data)
    switch(info.type) {
      case "01":
        drawRect(info.pos);
        break;
      case "02":
        fillRect(info.color, info.pos);
        break;
      case "04":
        console.log("in bmp")
        break;
    }
  };
  websocket.onerror = function (evt) { 
    console.log('Error occured: ' + evt.data); 
  };

  var canvas=document.getElementById('content');
  canvas.addEventListener("click", function (evt) {
    var mousePos = getMousePos(canvas, evt);
    var posJson = JSON.stringify(mousePos);
    console.log(mousePos.x +',' + mousePos.y);
    websocket.send(posJson);
   }, false);

  // 获取鼠标坐标，只保留整数部分
  function getMousePos(canvas, evt) {
    var rect = canvas.getBoundingClientRect();
    return {
      x: parseInt(evt.clientX - rect.left),
      y: parseInt(evt.clientY - rect.top)
    };
  }

  function argb2rgba(argb) {
    var a = parseInt(argb.substring(0,2),16)/255;
    var r = argb.substring(2,4);
    var g = argb.substring(4,6);
    var b = argb.substring(6);
    var rgba = "rgba("+r+","+g+","+b+"," + a + ")";
    console.log(rgba);
    return rgba;
  }

  function fillRect(color, data) {
    var ctx=canvas.getContext('2d');
    var x = parseInt(data.substring(0,4),16);
    var y = parseInt(data.substring(4,8),16);
    var w = parseInt(data.substring(8,12),16);
    var h = parseInt(data.substring(12),16);
    ctx.fillStyle = color;
    ctx.fillRect(x+0.5,y+0.5,w,h);
  }

  function drawRect(data) {
    var ctx=canvas.getContext('2d');
    var x = parseInt(data.substring(0,4),16);
    var y = parseInt(data.substring(4,8),16);
    var w = parseInt(data.substring(8,12),16);
    var h = parseInt(data.substring(12),16);
    ctx.strokeRect(x+0.5,y+0.5,w,h);
  }

</script>
</body>
</html>